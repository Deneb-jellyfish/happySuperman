<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>äºŒç»´ç è§£é”ç”»å»Š</title>
  <!-- äºŒç»´ç åº“ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; color:#333;
    }
    .header {
      text-align:center; padding:20px 0;
      background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
      margin-bottom:30px;
    }
    .header h1 { color:#fff; font-size:2.5rem; font-weight:300; margin-bottom:10px; }
    .stats { color: rgba(255,255,255,0.8); font-size:1rem; }

    .gallery {
      display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr));
      gap:25px; padding:20px; max-width:1200px; margin:0 auto;
    }
    .media-item {
      background:#fff; border-radius:20px; overflow:hidden;
      box-shadow:0 15px 35px rgba(0,0,0,.1);
      transition: all .4s cubic-bezier(.25,.46,.45,.94); position:relative;
    }
    .media-item:hover { transform: translateY(-10px); box-shadow:0 25px 50px rgba(0,0,0,.2); }

    .media-preview {
      width:100%; height:200px; background:#f8f9fa;
      display:flex; align-items:center; justify-content:center;
      position:relative; overflow:hidden;
    }
    .media-preview img, .media-preview video {
      width:100%; height:100%; object-fit:cover; transition:filter .3s ease;
    }
    .locked .media-preview img, .locked .media-preview video { filter: blur(20px) brightness(.3); }

    .lock-overlay {
      position:absolute; inset:0; background: rgba(0,0,0,.7);
      display:flex; align-items:center; justify-content:center;
      color:#fff; font-size:3rem; opacity:0; transition:opacity .3s ease;
    }
    .locked .lock-overlay { opacity:1; }

    .media-info { padding:20px; }
    .media-title { font-size:1.3rem; font-weight:600; margin-bottom:8px; color:#2c3e50; }
    .media-description { color:#7f8c8d; font-size:.95rem; margin-bottom:15px; line-height:1.4; }

    .unlock-status {
      display:inline-block; padding:5px 15px; border-radius:15px;
      font-size:.8rem; font-weight:500; margin-bottom:10px;
    }
    .status-locked { background:#e74c3c; color:#fff; }
    .status-unlocked { background:#27ae60; color:#fff; }

    .media-type-badge {
      position:absolute; top:15px; right:15px;
      background:rgba(0,0,0,.7); color:#fff;
      padding:5px 12px; border-radius:15px; font-size:.8rem; font-weight:500;
    }

    .qr-section { margin-top:15px; text-align:center; }
    .qr-code {
      display:inline-block; padding:10px; background:#fff; border-radius:10px;
      box-shadow:0 5px 15px rgba(0,0,0,.1); margin:10px 0;
    }
    .qr-instructions { color:#7f8c8d; font-size:.85rem; margin-top:5px; }

    /* è¯¦æƒ…é¡µæ ·å¼ */
    .detail-page { display:none; min-height:100vh; padding:0; }
    .detail-page.active { display:block; }
    .detail-header {
      background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
      padding:20px 0; text-align:center; color:#fff;
    }
    .detail-header h1 { font-size:2rem; font-weight:300; margin-bottom:5px; }
    .detail-header .subtitle { opacity:.8; font-size:1rem; }

    .detail-content {
      max-width:800px; margin:0 auto; padding:40px 20px; background:#fff;
      margin-top:30px; margin-bottom:30px; border-radius:20px;
      box-shadow:0 15px 35px rgba(0,0,0,.1);
    }
    .detail-media { width:100%; max-height:400px; object-fit:cover; border-radius:15px; margin-bottom:25px; }
    .detail-description { font-size:1.2rem; color:#7f8c8d; margin-bottom:30px; text-align:center; line-height:1.6; }

    .unlock-section {
      text-align:center; padding:30px;
      background: linear-gradient(45deg, #667eea, #764ba2);
      border-radius:15px; color:#fff; margin-top:30px;
    }
    .unlock-btn {
      background: rgba(255,255,255,.2); border:2px solid rgba(255,255,255,.3);
      color:#fff; padding:15px 40px; border-radius:30px; font-size:1.2rem;
      cursor:pointer; transition:all .3s ease; margin-top:20px;
    }
    .unlock-btn:hover { background: rgba(255,255,255,.3); border-color: rgba(255,255,255,.5); transform: translateY(-2px); }
    .unlock-btn:disabled { opacity:.6; cursor:not-allowed; transform:none; }
    .unlock-message { margin-top:20px; padding:15px; background: rgba(39,174,96,.9); border-radius:10px; display:none; }

    .back-btn {
      position:fixed; top:20px; left:20px; background:rgba(255,255,255,.9);
      border:none; padding:12px 20px; border-radius:25px; cursor:pointer;
      font-weight:500; color:#2c3e50; text-decoration:none; display:flex; align-items:center; gap:8px;
      z-index:100; transition:all .3s ease;
    }
    .back-btn:hover { background:#fff; transform: translateY(-2px); box-shadow:0 5px 15px rgba(0,0,0,.2); }

    @media (max-width: 768px) {
      .gallery { grid-template-columns:1fr; padding:15px; }
      .detail-content { margin:20px; padding:30px 20px; }
      .header h1 { font-size:2rem; }
      .detail-header h1 { font-size:1.5rem; }
    }
  </style>
</head>
<body>
  <!-- ä¸»é¡µé¢ -->
  <div id="mainPage">
    <div class="header">
      <h1>ğŸ¨ æ™ºèƒ½ç”»å»Š</h1>
      <div class="stats">
        <span id="unlocked-count">0</span> / <span id="total-count">6</span> å·²è§£é”
      </div>
    </div>
    <div class="gallery" id="gallery"></div>
  </div>

  <!-- è¯¦æƒ…é¡µé¢ -->
  <div id="detailPage" class="detail-page">
    <a href="#" class="back-btn" onclick="showMainPage()">â† è¿”å›ç”»å»Š</a>
    <div class="detail-header">
      <h1 id="detailTitle">è¯¦æƒ…é¡µ</h1>
      <div class="subtitle">æ‰«ç è®¿é—®è§£é”å†…å®¹</div>
    </div>
    <div class="detail-content" id="detailContent"></div>
  </div>

  <script>
    // ====== â‘  åç«¯ API åŸºå€ï¼ˆä½ çš„ Netlify Functions åŸŸåï¼‰======
    const API_BASE = "https://deneb671.netlify.app/.netlify/functions";

    // ====== â‘¡ å…¨å±€è§£é”çŠ¶æ€ï¼ˆç”±åç«¯å¡«å……ï¼‰======
    let globalUnlockStatus = {};

    // ====== åª’ä½“æ•°æ®ï¼ˆå¯ç…§ä½ å®é™…æ›¿æ¢ï¼‰======
    const mediaData = [
      { id:1, title:"å¤œç©ºä¸­çš„æ˜Ÿè¾°", description:"ç’€ç’¨æ˜Ÿç©ºä¸‹çš„å®é™å¤œæ™š...", type:"image",
        src:"https://images.unsplash.com/photo-1446776877081-d282a0f896e2?w=1200",
        get unlocked(){ return globalUnlockStatus[this.id]; } },
      { id:2, title:"æµ·æµªéŸ³ä¹ä¼š", description:"æµ·æµªæ‹å‡»ç¤çŸ³çš„è‡ªç„¶éŸ³ä¹...", type:"video",
        src:"https://sample-videos.com/zip/10/mp4/360p/SampleVideo_360x240_1mb.mp4",
        get unlocked(){ return globalUnlockStatus[this.id]; } },
      { id:3, title:"å±±å·…æ—¥å‡º", description:"ç¬¬ä¸€ç¼•é˜³å…‰ç©¿ç ´äº‘å±‚...", type:"image",
        src:"https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=1200",
        get unlocked(){ return globalUnlockStatus[this.id]; } },
      { id:4, title:"æ£®æ—æ¼«æ­¥", description:"é˜³å…‰é€è¿‡æ ‘å¶æ´’ä¸‹çš„å…‰å½±...", type:"video",
        src:"https://sample-videos.com/zip/10/mp4/360p/SampleVideo_360x240_1mb.mp4",
        get unlocked(){ return globalUnlockStatus[this.id]; } },
      { id:5, title:"åŸå¸‚å¤œæ™¯", description:"éœ“è™¹ç¯ä¸‹çš„éƒ½å¸‚å¤œæ™š...", type:"image",
        src:"https://images.unsplash.com/photo-1514565131-fce0801e5785?w=1200",
        get unlocked(){ return globalUnlockStatus[this.id]; } },
      { id:6, title:"é›¨æ»´åå¥æ›²", description:"é›¨æ»´æ•²å‡»çª—å°çš„è‡ªç„¶æ—‹å¾‹...", type:"video",
        src:"https://sample-videos.com/zip/10/mp4/360p/SampleVideo_360x240_1mb.mp4",
        get unlocked(){ return globalUnlockStatus[this.id]; } },
    ];

    // ====== è¯»å–åç«¯è§£é”çŠ¶æ€ ======
    async function fetchUnlockStatus() {
      try {
        const res = await fetch(`${API_BASE}/getUnlocks`);
        globalUnlockStatus = await res.json();
      } catch (e) {
        console.error("è¯»å–è§£é”çŠ¶æ€å¤±è´¥ï¼Œä½¿ç”¨å…œåº•ï¼š", e);
        globalUnlockStatus = {1:false,2:false,3:true,4:true,5:false,6:false};
      } finally {
        init(); // è¯»å–å®Œæˆå†æ¸²æŸ“
      }
    }

    // ====== æ¸²æŸ“ç”»å»Š ======
    function renderGallery() {
      const gallery = document.getElementById('gallery');
      const unlockedCount = mediaData.filter(item => item.unlocked).length;

      document.getElementById('unlocked-count').textContent = unlockedCount;
      document.getElementById('total-count').textContent = mediaData.length;

      gallery.innerHTML = mediaData.map(item => {
        // å‰ç«¯å›ºå®šä½¿ç”¨ä½ çš„ GitHub Pages åŸŸåä½œä¸ºè¯¦æƒ…é“¾æ¥ï¼ˆç”¨äºäºŒç»´ç ï¼‰
        const detailUrl = `https://deneb-jellyfish.github.io/happySuperman/?item=${item.id}`;
        return `
          <div class="media-item ${item.unlocked ? '' : 'locked'}">
            <div class="media-preview">
              ${item.type === 'image'
                ? `<img src="${item.src}" alt="${item.title}">`
                : `<video src="${item.src}" muted></video>`}
              <div class="media-type-badge">${item.type === 'image' ? 'ğŸ“· å›¾ç‰‡' : 'ğŸ¥ è§†é¢‘'}</div>
              <div class="lock-overlay">ğŸ”’</div>
            </div>
            <div class="media-info">
              <div class="unlock-status ${item.unlocked ? 'status-unlocked' : 'status-locked'}">
                ${item.unlocked ? 'âœ“ å·²è§£é”' : 'ğŸ”’ å·²é”å®š'}
              </div>
              <h3 class="media-title">${item.title}</h3>
              <p class="media-description">${item.description.substring(0, 50)}...</p>
              <div class="qr-section">
                <div class="qr-code" id="qr-${item.id}"></div>
                <p class="qr-instructions">æ‰«ç æŸ¥çœ‹è¯¦æƒ…${item.unlocked ? '' : 'å¹¶è§£é”å†…å®¹'}</p>
              </div>
            </div>
          </div>
        `;
      }).join('');

      // ç”ŸæˆäºŒç»´ç 
      setTimeout(() => {
        mediaData.forEach(item => {
          const qrElement = document.getElementById(`qr-${item.id}`);
          if (qrElement) {
            const detailUrl = `https://deneb-jellyfish.github.io/happySuperman/?item=${item.id}`;
            qrElement.innerHTML = '';
            new QRCode(qrElement, {
              text: detailUrl, width: 120, height: 120,
              colorDark: "#2c3e50", colorLight: "#ffffff"
            });
          }
        });
      }, 50);
    }

    // ====== æ˜¾ç¤ºè¯¦æƒ…é¡µ ======
    function showDetailPage(itemId) {
      const item = mediaData.find(m => m.id === itemId);
      if (!item) return;

      document.getElementById('mainPage').style.display = 'none';
      document.getElementById('detailPage').classList.add('active');

      document.getElementById('detailTitle').textContent = item.title;
      const detailContent = document.getElementById('detailContent');
      detailContent.innerHTML = `
        ${item.type === 'image'
          ? `<img src="${item.src}" alt="${item.title}" class="detail-media">`
          : `<video src="${item.src}" class="detail-media" controls></video>`}
        <p class="detail-description">${item.description}</p>
        <div class="unlock-section">
          <h3>ğŸ”“ è§£é”æ­¤å†…å®¹</h3>
          <p>è§£é”åï¼Œæ­¤å†…å®¹å°†åœ¨ä¸»é¡µé¢ä¸­å®Œæ•´æ˜¾ç¤ºï¼Œä¸å†æ¨¡ç³Šå¤„ç†</p>
          <button id="unlockBtn" class="unlock-btn" onclick="handleUnlock(${itemId})" ${item.unlocked ? 'disabled' : ''}>
            ${item.unlocked ? 'âœ“ å·²è§£é”' : 'ğŸ”“ ç«‹å³è§£é”'}
          </button>
          <div id="unlockMessage" class="unlock-message"></div>
        </div>
      `;
    }

    // ====== è¿”å›ä¸»é¡µé¢å¹¶åˆ·æ–°åˆ—è¡¨ ======
    function showMainPage() {
      document.getElementById('detailPage').classList.remove('active');
      document.getElementById('mainPage').style.display = 'block';
      renderGallery();

      if (window.history && window.history.replaceState) {
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    }

    // ====== è§£é”ï¼šè°ƒç”¨åç«¯å†™å…¥å¹¶æ›´æ–° UI ======
    async function unlockItem(itemId) {
      if (globalUnlockStatus[itemId]) return true;
      try {
        const res = await fetch(`${API_BASE}/unlockItem`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: itemId })
        });
        const data = await res.json();
        if (res.ok && data?.success) {
          globalUnlockStatus[itemId] = true;

          if (document.getElementById('mainPage').style.display !== 'none') {
            renderGallery();
          }
          const unlockMessage = document.getElementById('unlockMessage');
          if (unlockMessage) {
            const item = mediaData.find(m => m.id === itemId);
            unlockMessage.style.display = 'block';
            unlockMessage.innerHTML = `ğŸ‰ "${item.title}" å·²æˆåŠŸè§£é”ï¼ç°åœ¨æ‰€æœ‰è®¿é—®è€…éƒ½å¯ä»¥çœ‹åˆ°å®Œæ•´å†…å®¹ã€‚`;

            const unlockBtn = document.getElementById('unlockBtn');
            if (unlockBtn) { unlockBtn.disabled = true; unlockBtn.textContent = 'âœ“ å·²è§£é”'; }
          }
          return true;
        } else {
          console.error("è§£é”å¤±è´¥ï¼š", data);
          return false;
        }
      } catch (e) {
        console.error("è§£é”è¯·æ±‚å¼‚å¸¸ï¼š", e);
        return false;
      }
    }

    function handleUnlock(itemId) {
      unlockItem(itemId).then(ok => { if (ok) console.log(`Item ${itemId} unlocked`); });
    }

    // ====== é€šè¿‡ URL å‚æ•°è¿›å…¥è¯¦æƒ…é¡µï¼ˆç”¨äºäºŒç»´ç ï¼‰======
    function checkUrlParams() {
      const urlParams = new URLSearchParams(window.location.search);
      const itemId = urlParams.get('item');
      if (itemId) {
        const id = parseInt(itemId);
        if (mediaData.find(m => m.id === id)) {
          showDetailPage(id);
          return true;
        }
      }
      return false;
    }

    // ====== åˆå§‹åŒ–ï¼šå…ˆè¯»å–åç«¯çŠ¶æ€ï¼Œå†æ¸²æŸ“æˆ–å±•ç¤ºè¯¦æƒ… ======
    function init() {
      if (!checkUrlParams()) renderGallery();
    }

    // é¡µé¢åŠ è½½ â†’ å…ˆè¯»åç«¯çŠ¶æ€
    document.addEventListener('DOMContentLoaded', fetchUnlockStatus);
  </script>
</body>
</html>
